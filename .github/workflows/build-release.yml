name: ðŸš€ Build & Package for Windows, macOS, Linux

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºŽæµ‹è¯•ï¼‰
  release:
    types: [published]  # è‡ªåŠ¨è§¦å‘ï¼ˆå½“åˆ›å»º Release æ—¶ï¼‰

jobs:
  build-windows:
    name: ðŸªŸ Build Windows Installer
    runs-on: windows-latest
    defaults:
      run:
        working-directory: yt_client_flutter

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ”¨ Build Windows app
        run: flutter build windows --release

      - name: ðŸ“ Prepare app folder
        run: |
          mkdir release
          xcopy /E /I "build\windows\x64\runner\Release" "release\yt_client_flutter"

      - name: ðŸ› ï¸ Create installer with Inno Setup
        run: |
          choco install innosetup -y
          $version = if ("${{ github.event_name }}" -eq "release") { "${{ github.event.tag_name }}" } else { "dev" }
          echo [Setup] > installer.iss
          echo AppName=yt_client_flutter >> installer.iss
          echo AppVersion=$version >> installer.iss
          echo DefaultDirName={autopf}\yt_client_flutter >> installer.iss
          echo DefaultGroupName=yt_client_flutter >> installer.iss
          echo OutputDir=. >> installer.iss
          echo OutputBaseFilename=yt_client_flutter-Setup-$version >> installer.iss
          echo Compression=lzma2 >> installer.iss
          echo SolidCompression=yes >> installer.iss
          echo [Files] >> installer.iss
          echo Source: "release\yt_client_flutter\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs >> installer.iss
          echo [Icons] >> installer.iss
          echo Name: "{autoprograms}\yt_client_flutter"; Filename: "{app}\yt_client_flutter.exe" >> installer.iss

      - name: â–¶ï¸ Compile installer
        run: ISCC installer.iss

      - name: ðŸ“¤ Upload as Artifact (for testing)
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: yt_client_flutter/yt_client_flutter-Setup-*.exe

      - name: ðŸ“¤ Publish to Release (if triggered by release)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: yt_client_flutter/yt_client_flutter-Setup-*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: ðŸ Build macOS DMG
    runs-on: macos-latest
    defaults:
      run:
        working-directory: yt_client_flutter

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ”¨ Build macOS app
        run: flutter build macos --release

      - name: ðŸ“¦ Rename app
        run: |
          cd build/macos/Build/Products/Release
          mv Runner.app yt_client_flutter.app

      - name: ðŸ§Š Create DMG with create-dmg
        run: |
          brew install create-dmg
          version="${{ github.event_name == 'release' && github.event.release.tag_name || 'dev' }}"
          create-dmg \
            --volname "yt_client_flutter" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 128 \
            --icon "yt_client_flutter.app" 200 190 \
            --hide-extension "yt_client_flutter.app" \
            --app-drop-link 600 190 \
            "yt_client_flutter-$version.dmg" \
            "build/macos/Build/Products/Release/yt_client_flutter.app"

      - name: ðŸ“¤ Upload as Artifact (for testing)
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: yt_client_flutter/yt_client_flutter-*.dmg

      - name: ðŸ“¤ Publish to Release (if triggered by release)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: yt_client_flutter/yt_client_flutter-*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: ðŸ§ Build Linux AppImage
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: yt_client_flutter

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ”¨ Build Linux app
        run: flutter build linux --release

      - name: ðŸ“¦ Prepare AppDir
        run: |
          mkdir -p yt_client_flutter.AppDir/usr/bin
          cp -r build/linux/x64/release/bundle/* yt_client_flutter.AppDir/
          chmod +x yt_client_flutter.AppDir/AppRun

          # åˆ›å»ºç®€å•çš„ desktop æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          mkdir -p yt_client_flutter.AppDir/usr/share/applications
          cat > yt_client_flutter.AppDir/yt_client_flutter.desktop <<EOF
          [Desktop Entry]
          Name=yt_client_flutter
          Exec=AppRun
          Icon=yt_client_flutter
          Type=Application
          Categories=Utility;
          EOF

          # å¤åˆ¶å›¾æ ‡ï¼ˆå‡è®¾ä½ æœ‰ assets/icon.pngï¼‰
          # mkdir -p yt_client_flutter.AppDir/usr/share/icons/hicolor/256x256/apps
          # cp ../assets/icon.png yt_client_flutter.AppDir/usr/share/icons/hicolor/256x256/apps/yt_client_flutter.png

      - name: ðŸ§Š Download and Run appimagetool
        run: |
          version="${{ github.event_name == 'release' && github.event.release.tag_name || 'dev' }}"
          wget https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool
          ./appimagetool yt_client_flutter.AppDir "yt_client_flutter-$version-x86_64.AppImage"

      - name: ðŸ“¤ Upload as Artifact (for testing)
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: yt_client_flutter/yt_client_flutter-*-x86_64.AppImage

      - name: ðŸ“¤ Publish to Release (if triggered by release)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: yt_client_flutter/yt_client_flutter-*-x86_64.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}