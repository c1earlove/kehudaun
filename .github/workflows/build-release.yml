name: ğŸš€ Build & Package for Windows, macOS, Linux

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  release:
    types: [published]  # è‡ªåŠ¨è§¦å‘ï¼ˆå½“å‘å¸ƒ Release æ—¶ï¼‰

jobs:
  build-windows:
    name: ğŸªŸ Build Windows Installer
    runs-on: windows-latest
    defaults:
      run:
        working-directory: yt_client_flutter

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ”¨ Build Windows app
        run: flutter build windows --release

      - name: ğŸ“ Prepare app folder
        run: |
          mkdir release
          xcopy /E /I "build\windows\x64\runner\Release" "release\yt_client_flutter"

      - name: ğŸ› ï¸ Create installer with Inno Setup
        run: |
          choco install innosetup -y
          $version = if ("${{ github.event_name }}" -eq "release") { "${{ github.event.release.tag_name }}".TrimStart('v') } else { "dev" }
          Add-Content -Path installer.iss -Value "[Setup]"
          Add-Content -Path installer.iss -Value "AppName=yt_client_flutter"
          Add-Content -Path installer.iss -Value "AppVersion=$version"
          Add-Content -Path installer.iss -Value "DefaultDirName={autopf}\yt_client_flutter"
          Add-Content -Path installer.iss -Value "DefaultGroupName=yt_client_flutter"
          Add-Content -Path installer.iss -Value "OutputDir=."
          Add-Content -Path installer.iss -Value "OutputBaseFilename=yt_client_flutter-Setup-$version"
          Add-Content -Path installer.iss -Value "Compression=lzma2"
          Add-Content -Path installer.iss -Value "SolidCompression=yes"
          Add-Content -Path installer.iss -Value ""
          Add-Content -Path installer.iss -Value "[Files]"
          Add-Content -Path installer.iss -Value 'Source: "release\yt_client_flutter\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs'
          Add-Content -Path installer.iss -Value ""
          Add-Content -Path installer.iss -Value "[Icons]"
          Add-Content -Path installer.iss -Value 'Name: "{autoprograms}\yt_client_flutter"; Filename: "{app}\yt_client_flutter.exe"'

      - name: â–¶ï¸ Compile installer
        run: ISCC installer.iss

      - name: ğŸ“¤ Upload as Artifact (for testing)
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: yt_client_flutter/yt_client_flutter-Setup-*.exe

      - name: ğŸ“¤ Publish to Release (if triggered by release)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: yt_client_flutter/yt_client_flutter-Setup-*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: ğŸ Build macOS DMG
    runs-on: macos-latest
    defaults:
      run:
        working-directory: yt_client_flutter

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ”¨ Build macOS app
        run: flutter build macos --release

      - name: ğŸ“‚ Verify build output
        run: |
          ls -la build/macos/Build/Products/Release/
          if [ ! -d "build/macos/Build/Products/Release/yt_client_flutter.app" ]; then
            echo "âŒ yt_client_flutter.app not found!"
            exit 1
          fi

      - name: ğŸ§Š Create DMG with create-dmg
        run: |
          brew install create-dmg
          version="${{ github.event_name == 'release' && github.event.release.tag_name || 'dev' }}"
          create-dmg \
            --volname "yt_client_flutter" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 128 \
            --icon "yt_client_flutter.app" 200 190 \
            --hide-extension "yt_client_flutter.app" \
            --app-drop-link 600 190 \
            "yt_client_flutter-$version.dmg" \
            "build/macos/Build/Products/Release/yt_client_flutter.app"

      - name: ğŸ“¤ Upload as Artifact (for testing)
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: yt_client_flutter/yt_client_flutter-*.dmg

      - name: ğŸ“¤ Publish to Release (if triggered by release)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: yt_client_flutter/yt_client_flutter-*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: ğŸ§ Build Linux AppImage
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: yt_client_flutter

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'

      - name: ğŸ“¦ Install Linux desktop dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libx11-dev \
            libgl1-mesa-dev \
            libegl1-mesa-dev \
            libdrm-dev \
            libgbm-dev \
            libudev-dev \
            libblkid-dev \
            libasound2-dev

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ”¨ Build Linux app
        run: flutter build linux --release

      - name: ğŸ“¦ Prepare AppDir
        run: |
          mkdir -p yt_client_flutter.AppDir
          cp -r build/linux/x64/release/bundle/* yt_client_flutter.AppDir/
          mv yt_client_flutter.AppDir/yt_client_flutter yt_client_flutter.AppDir/AppRun
          chmod +x yt_client_flutter.AppDir/AppRun

          printf '%s\n' \
            "[Desktop Entry]" \
            "Name=yt_client_flutter" \
            "Exec=AppRun" \
            "Icon=yt_client_flutter" \
            "Type=Application" \
            "Categories=Utility;" \
            "Terminal=false" \
            > yt_client_flutter.AppDir/yt_client_flutter.desktop

      - name: ğŸ–¼ï¸ Add placeholder icon (optional but required by AppImage spec)
        run: touch yt_client_flutter.AppDir/yt_client_flutter.png

      - name: ğŸ§Š Download and Run appimagetool
        run: |
          version="${{ github.event_name == 'release' && github.event.release.tag_name || 'dev' }}"
          wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage
          chmod +x appimagetool
          ./appimagetool yt_client_flutter.AppDir "yt_client_flutter-$version-x86_64.AppImage"

      - name: ğŸ“¤ Upload as Artifact (for testing)
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: yt_client_flutter/yt_client_flutter-*-x86_64.AppImage

      - name: ğŸ“¤ Publish to Release (if triggered by release)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: yt_client_flutter/yt_client_flutter-*-x86_64.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}