# .github/workflows/build-release.yml
name: ğŸš€ Build & Package for Windows + macOS

on:
  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ¨èç”¨äºæ­£å¼å‘å¸ƒï¼‰
  workflow_dispatch:

  # å½“å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆåœ¨ GitHub Releases é¡µé¢åˆ›å»ºæ–° Releaseï¼‰
  release:
    types: [published]

jobs:
  build-windows:
    name: ğŸªŸ Build Windows Installer
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'  # æ›¿æ¢ä¸ºä½ é¡¹ç›®ä½¿ç”¨çš„ Flutter ç‰ˆæœ¬
          channel: 'stable'

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ”¨ Build Windows app
        run: flutter build windows --release

      - name: ğŸ“ Prepare app folder
        run: |
          mkdir release
          xcopy /E /I "build\windows\x64\runner\Release" "release\YourApp"

      - name: ğŸ› ï¸ Create installer with Inno Setup
        run: |
          choco install innosetup -y
          # åˆ›å»ºç®€å•çš„ iss è„šæœ¬ï¼ˆä½ ä¹Ÿå¯ä»¥æäº¤è‡ªå·±çš„ iss æ–‡ä»¶ï¼‰
          echo [Setup] > installer.iss
          echo AppName=YourApp >> installer.iss
          echo AppVersion=${{ github.ref_name || '1.0.0' }} >> installer.iss
          echo DefaultDirName={autopf}\YourApp >> installer.iss
          echo DefaultGroupName=YourApp >> installer.iss
          echo OutputDir=. >> installer.iss
          echo OutputBaseFilename=YourApp-Setup-${{ github.ref_name || '1.0.0' }} >> installer.iss
          echo Compression=lzma2 >> installer.iss
          echo SolidCompression=yes >> installer.iss
          echo [Files] >> installer.iss
          echo Source: "release\YourApp\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs >> installer.iss
          echo [Icons] >> installer.iss
          echo Name: "{autoprograms}\YourApp"; Filename: "{app}\YourApp.exe" >> installer.iss
          echo Name: "{autodesktop}\YourApp"; Filename: "{app}\YourApp.exe"; Tasks: desktopicon >> installer.iss

      - name: â–¶ï¸ Compile installer
        run: ISCC installer.iss

      - name: ğŸ“¤ Upload Windows installer to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: YourApp-Setup-*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: ğŸ Build macOS DMG
    runs-on: macos-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'  # ä¸ Windows ä¸€è‡´
          channel: 'stable'

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ”¨ Build macOS app
        run: flutter build macos --release

      - name: ğŸ“¦ Rename app (optional)
        run: |
          cd build/macos/Build/Products/Release
          mv Runner.app YourApp.app

      - name: ğŸ§Š Create DMG with create-dmg
        run: |
          brew install create-dmg
          create-dmg \
            --volname "YourApp" \
            --window-pos 200 120 \
            --window-size 1440 800 \
            --icon-size 128 \
            --icon "YourApp.app" 200 190 \
            --hide-extension "YourApp.app" \
            --app-drop-link 600 190 \
            "YourApp-${{ github.ref_name || '1.0.0' }}.dmg" \
            "build/macos/Build/Products/Release/YourApp.app"

      - name: ğŸ“¤ Upload macOS DMG to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: YourApp-*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}